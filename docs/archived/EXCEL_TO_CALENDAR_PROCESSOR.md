# Excel转日历处理器

> ⚠️ **已归档**：此文档已过时。该脚本的功能已整合到 `comprehensive_excel_processor.py` 中。  
> 📅 **归档日期**：2025-01-XX  
> 📝 **替代文档**：请参考 `scripts/README.md` 和 `docs/EXCEL_PROCESSING_SOLUTION.md`

---

## 概述

`excel_to_calendar_processor.py` 是一个专门用于处理 `publish_excel/` 目录下Excel文件并写入到 `publish_history_for_calendar.csv` 的脚本。该脚本具备完善的去重功能和增量更新能力。

**注意**：此脚本已不存在，功能已整合到 `comprehensive_excel_processor.py` 中。

## 功能特点

### 1. 多平台支持
- **头条号**: 自动识别文件名中的"头条-"前缀
- **百家号**: 自动识别文件名中的"百家号-"前缀
- **自动账号命名**: 根据文件名自动生成账号名称

### 2. 智能列映射
脚本能够自动识别和映射以下列名变体：

| 目标列 | 支持的列名变体 |
|--------|----------------|
| 标题 | 标题, title, Title, 文章标题, 文章名 |
| 发布时间 | 发布时间, publish_time, PublishTime, 日期, Date |
| 阅读量 | 阅读量, read_count, ReadCount, 阅读数, 阅读, views |
| 点赞量 | 点赞量, like_count, LikeCount, 点赞数, 点赞, likes |
| 评论量 | 评论量, comment_count, CommentCount, 评论数, 评论, comments |
| 链接 | 链接, link, Link, URL, url, 文章链接 |

### 3. 数据清理
- **标题清理**: 移除多余引号，限制长度
- **时间标准化**: 支持多种时间格式，统一为 `YYYY-MM-DD HH:MM:SS`
- **数值清理**: 自动清理非数字字符，处理空值
- **空记录过滤**: 自动移除标题为空的记录

### 4. 去重机制
- **新数据内部去重**: 处理Excel文件内的重复记录
- **新旧数据对比**: 智能识别新记录和需要更新的记录
- **最终去重**: 确保最终数据无重复
- **增量更新**: 只更新数据字段，保持记录完整性

## 使用方法

### 基本使用
```bash
# 在项目根目录下运行
python scripts/excel_to_calendar_processor.py
```

### 处理流程
1. **扫描Excel文件**: 自动扫描 `scripts/publish_excel/` 目录
2. **逐个处理**: 处理每个Excel文件
3. **数据标准化**: 统一列名和数据结构
4. **数据清理**: 清理和验证数据
5. **去重处理**: 移除重复记录
6. **增量更新**: 与现有CSV文件合并
7. **保存结果**: 写入到 `publish_history_for_calendar.csv`

## 文件结构

### 输入目录
```
scripts/publish_excel/
├── 头条-AGI观察室.xlsx
├── 头条-漫游指南.xlsx
├── 头条-看山先生.xlsx
├── 头条-观察室.xlsx
├── 百家号-AGI启示录.xlsx
└── 百家号-看山.xlsx
```

### 输出文件
```
workspace/data/publish_history_for_calendar.csv
```

## 输出格式

### CSV文件结构
```csv
标题,账号名称,发布时间,阅读量,点赞量,评论量,链接
"文章标题",头条号-账号名,2025-01-01 12:00:00,100,10,5,https://example.com
```

### 账号命名规则
- **头条号**: `头条号-{文件名中的账号名}`
- **百家号**: `百家号-{文件名中的账号名}`

## 错误处理

### Excel文件读取
- 优先使用 `openpyxl` 引擎
- 失败时尝试 `xlrd` 引擎
- 无法读取的文件会被跳过并记录错误

### 数据验证
- 空文件自动跳过
- 无效数据自动清理
- 错误记录详细日志

## 日志输出

### 处理过程日志
```
🚀 开始处理Excel文件...
📁 找到 6 个Excel文件
📖 正在处理文件: /path/to/file.xlsx
📊 原始数据: 10 行
✅ 处理后数据: 10 行
📚 现有数据: 177 条
➕ 发现 11 条新记录
🔄 发现 0 条需要更新的记录
🔗 合并后共 188 条记录
💾 数据已保存到 /path/to/file.csv，共 188 条记录
🎉 所有Excel文件处理完成！
```

### 去重统计
```
🔍 去重后数据: 10 条
🧹 最终去重：移除 2 条重复记录
🧽 最终清理：移除 1 条重复记录
```

## 配置选项

### 时间格式支持
```python
time_formats = [
    '%Y-%m-%d %H:%M:%S',  # 2025-01-01 12:00:00
    '%Y-%m-%d',           # 2025-01-01
    '%Y/%m/%d %H:%M:%S',  # 2025/01/01 12:00:00
    '%Y/%m/%d',           # 2025/01/01
    '%m/%d/%Y %H:%M:%S',  # 01/01/2025 12:00:00
    '%m/%d/%Y',           # 01/01/2025
    '%d/%m/%Y %H:%M:%S',  # 01/01/2025 12:00:00
    '%d/%m/%Y'            # 01/01/2025
]
```

### 列名映射
可以通过修改 `column_mapping` 字典来添加新的列名变体：

```python
column_mapping = {
    '标题': ['标题', 'title', 'Title', '文章标题', '文章名', '新列名'],
    # ... 其他列
}
```

## 性能优化

### 内存管理
- 逐个处理Excel文件，避免内存溢出
- 及时清理临时数据
- 使用pandas的高效操作

### 增量更新
- 只处理变化的数据
- 智能识别新记录和更新记录
- 避免重复处理

## 故障排除

### 常见问题

1. **Excel文件无法读取**
   - 检查文件格式是否为 `.xlsx` 或 `.xls`
   - 确保文件没有损坏
   - 尝试用Excel重新保存文件

2. **列名无法识别**
   - 检查Excel文件中的列名
   - 在 `column_mapping` 中添加新的列名变体

3. **时间格式无法解析**
   - 检查时间数据的格式
   - 在 `time_formats` 中添加新的格式

4. **数据重复**
   - 检查去重逻辑是否正确
   - 确认唯一标识符的构成

### 调试方法

```python
# 启用详细日志
import logging
logging.basicConfig(level=logging.DEBUG)

# 检查特定文件
df = process_excel_file("path/to/specific/file.xlsx")
print(df.head())
```

## 扩展功能

### 添加新平台
1. 在 `standardize_columns` 函数中添加新的平台识别逻辑
2. 更新账号命名规则
3. 添加平台特定的数据处理逻辑

### 自定义数据处理
1. 修改 `clean_title`, `clean_publish_time`, `clean_numeric_value` 函数
2. 添加新的数据验证规则
3. 实现自定义的数据转换逻辑

## 注意事项

1. **文件权限**: 确保脚本有读取Excel文件和写入CSV文件的权限
2. **编码问题**: 所有文件使用UTF-8编码
3. **数据备份**: 建议在处理前备份重要的CSV文件
4. **定期运行**: 建议定期运行脚本以保持数据同步

## 版本历史

- **v1.0**: 初始版本，支持基本的Excel处理和去重功能
- **v1.1**: 添加多引擎支持，改进错误处理
- **v1.2**: 优化去重逻辑，添加增量更新功能

---

**最后更新**: 2025年9月13日
