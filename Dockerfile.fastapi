# FastAPI æœåŠ¡ Dockerfile
FROM python:3.14-slim

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# é…ç½® Debian é•œåƒæºï¼ˆä½¿ç”¨æ¸…åå¤§å­¦é•œåƒï¼ŒDebian 13 trixieï¼‰
RUN if [ -f /etc/apt/sources.list.d/debian.sources ]; then \
        sed -i 's|http://deb.debian.org|https://mirrors.tuna.tsinghua.edu.cn|g' /etc/apt/sources.list.d/debian.sources && \
        sed -i 's|http://snapshot.debian.org|https://mirrors.tuna.tsinghua.edu.cn|g' /etc/apt/sources.list.d/debian.sources; \
    else \
        echo "Types: deb" > /etc/apt/sources.list.d/debian.sources && \
        echo "URIs: https://mirrors.tuna.tsinghua.edu.cn/debian" >> /etc/apt/sources.list.d/debian.sources && \
        echo "Suites: trixie trixie-updates" >> /etc/apt/sources.list.d/debian.sources && \
        echo "Components: main contrib non-free non-free-firmware" >> /etc/apt/sources.list.d/debian.sources && \
        echo "Signed-By: /usr/share/keyrings/debian-archive-keyring.gpg" >> /etc/apt/sources.list.d/debian.sources && \
        echo "" >> /etc/apt/sources.list.d/debian.sources && \
        echo "Types: deb" >> /etc/apt/sources.list.d/debian.sources && \
        echo "URIs: https://mirrors.tuna.tsinghua.edu.cn/debian-security" >> /etc/apt/sources.list.d/debian.sources && \
        echo "Suites: trixie-security" >> /etc/apt/sources.list.d/debian.sources && \
        echo "Components: main contrib non-free non-free-firmware" >> /etc/apt/sources.list.d/debian.sources && \
        echo "Signed-By: /usr/share/keyrings/debian-archive-keyring.gpg" >> /etc/apt/sources.list.d/debian.sources; \
    fi

# å®‰è£…ç³»ç»Ÿä¾èµ–ï¼ˆåŒ…æ‹¬ç¼–è¯‘å·¥å…·ï¼Œç”¨äºæ„å»º Python åŒ…ï¼‰
RUN apt-get update --fix-missing && \
    apt-get install -y --no-install-recommends \
    gcc \
    g++ \
    curl \
    cmake \
    make \
    build-essential \
    libssl-dev \
    libffi-dev \
    pkg-config \
    ninja-build \
    && rm -rf /var/lib/apt/lists/*

# é…ç½® pip é•œåƒæºï¼ˆä½¿ç”¨æ¸…åå¤§å­¦é•œåƒï¼‰
RUN pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple && \
    pip config set global.trusted-host pypi.tuna.tsinghua.edu.cn

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY requirements/ ./requirements/

# å®‰è£… Python ä¾èµ–
RUN echo "ğŸ“¦ å®‰è£… FastAPI åç«¯ä¾èµ–..." && \
    pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements/fastapi.txt && \
    echo "âœ… FastAPI ä¾èµ–å®‰è£…å®Œæˆ" && \
    pip show fastapi | head -3

RUN echo "âœ… éªŒè¯å…³é”®åŒ…..." && \
    (python -c "import fastapi; import uvicorn; print('âœ… FastAPI å’Œ uvicorn å¯ç”¨')" || echo "âš ï¸  FastAPI å¯¼å…¥å¤±è´¥") && \
    (python -c "import sqlalchemy; print('âœ… SQLAlchemy å¯ç”¨')" || echo "âš ï¸  SQLAlchemy å¯¼å…¥å¤±è´¥") && \
    (python -c "import langgraph; print('âœ… LangGraph å¯ç”¨')" || echo "âš ï¸  LangGraph å¯¼å…¥å¤±è´¥") && \
    (python -m uvicorn --version || echo "âš ï¸  uvicorn å‘½ä»¤å¤±è´¥ï¼Œä½†åŒ…å·²å®‰è£…")

# æ³¨æ„ï¼šä»£ç é€šè¿‡ volume æŒ‚è½½ï¼Œä¸éœ€è¦ COPY
# è¿™æ ·å¯ä»¥å®ç°å¼€å‘æ¨¡å¼ä¸‹çš„çƒ­é‡è½½

# æš´éœ² FastAPI ç«¯å£
EXPOSE 8000

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8000/health || exit 1

# é»˜è®¤å‘½ä»¤ï¼ˆä¼šè¢« docker-compose è¦†ç›–ï¼‰
CMD ["python", "-m", "uvicorn", "api.main:app", "--host", "0.0.0.0", "--port", "8000"]

