# FastAPI æœåŠ¡ Dockerfile
FROM python:3.14-slim

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# é…ç½® Debian é•œåƒæºï¼ˆä½¿ç”¨æ¸…åå¤§å­¦é•œåƒï¼ŒDebian 13 trixieï¼‰
RUN if [ -f /etc/apt/sources.list.d/debian.sources ]; then \
        sed -i 's|http://deb.debian.org|https://mirrors.tuna.tsinghua.edu.cn|g' /etc/apt/sources.list.d/debian.sources && \
        sed -i 's|http://snapshot.debian.org|https://mirrors.tuna.tsinghua.edu.cn|g' /etc/apt/sources.list.d/debian.sources; \
    else \
        echo "Types: deb" > /etc/apt/sources.list.d/debian.sources && \
        echo "URIs: https://mirrors.tuna.tsinghua.edu.cn/debian" >> /etc/apt/sources.list.d/debian.sources && \
        echo "Suites: trixie trixie-updates" >> /etc/apt/sources.list.d/debian.sources && \
        echo "Components: main contrib non-free non-free-firmware" >> /etc/apt/sources.list.d/debian.sources && \
        echo "Signed-By: /usr/share/keyrings/debian-archive-keyring.gpg" >> /etc/apt/sources.list.d/debian.sources && \
        echo "" >> /etc/apt/sources.list.d/debian.sources && \
        echo "Types: deb" >> /etc/apt/sources.list.d/debian.sources && \
        echo "URIs: https://mirrors.tuna.tsinghua.edu.cn/debian-security" >> /etc/apt/sources.list.d/debian.sources && \
        echo "Suites: trixie-security" >> /etc/apt/sources.list.d/debian.sources && \
        echo "Components: main contrib non-free non-free-firmware" >> /etc/apt/sources.list.d/debian.sources && \
        echo "Signed-By: /usr/share/keyrings/debian-archive-keyring.gpg" >> /etc/apt/sources.list.d/debian.sources; \
    fi

# å®‰è£…ç³»ç»Ÿä¾èµ–ï¼ˆåŒ…æ‹¬ç¼–è¯‘å·¥å…·ï¼Œç”¨äºæ„å»º Python åŒ…ï¼‰
RUN apt-get update --fix-missing && \
    apt-get install -y --no-install-recommends \
    gcc \
    g++ \
    curl \
    cmake \
    make \
    build-essential \
    libssl-dev \
    libffi-dev \
    pkg-config \
    ninja-build \
    && rm -rf /var/lib/apt/lists/*

# é…ç½® pip é•œåƒæºï¼ˆä½¿ç”¨æ¸…åå¤§å­¦é•œåƒï¼‰
RUN pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple && \
    pip config set global.trusted-host pypi.tuna.tsinghua.edu.cn

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY requirements.txt .

# å®‰è£… Python ä¾èµ–
# åˆ†æ­¥å®‰è£…ï¼Œç¡®ä¿æ ¸å¿ƒåŒ…å…ˆå®‰è£…æˆåŠŸ
RUN echo "ğŸ“¦ ç¬¬ä¸€æ­¥ï¼šå®‰è£… FastAPI æ ¸å¿ƒä¾èµ–..." && \
    pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir fastapi "uvicorn[standard]" && \
    echo "âœ… FastAPI å’Œ uvicorn å·²å®‰è£…" && \
    python -m uvicorn --version

RUN echo "ğŸ“¦ ç¬¬äºŒæ­¥ï¼šå®‰è£…å…¶ä»–æ ¸å¿ƒä¾èµ–..." && \
    pip install --no-cache-dir requests httpx sqlalchemy psycopg2-binary alembic langgraph langchain-core langchain-openai python-dotenv pydantic python-multipart

RUN echo "ğŸ“¦ ç¬¬ä¸‰æ­¥ï¼šå®‰è£…æ•°æ®å¤„ç†ä¾èµ–..." && \
    pip install --no-cache-dir pandas openpyxl xlrd jinja2 markdown markdownify bs4

RUN echo "ğŸ“¦ ç¬¬å››æ­¥ï¼šå®‰è£…å…¶ä»–å·¥å…·..." && \
    (pip install --no-cache-dir selenium webdriver-manager || echo "âš ï¸  selenium å®‰è£…å¤±è´¥") && \
    (pip install --no-cache-dir streamlit || echo "âš ï¸  streamlit å®‰è£…å¤±è´¥")

RUN echo "ğŸ“¦ ç¬¬äº”æ­¥ï¼šå°è¯•å®‰è£…å¯é€‰ä¾èµ–ï¼ˆplotly, pyarrowï¼‰..." && \
    (pip install --no-cache-dir plotly 2>&1 | head -5 || echo "âš ï¸  plotly å®‰è£…å¤±è´¥") && \
    (pip install --no-cache-dir --only-binary=:all: pyarrow 2>/dev/null || \
     pip install --no-cache-dir pyarrow 2>/dev/null || \
     echo "âš ï¸  pyarrow å®‰è£…å¤±è´¥ï¼Œå°†è·³è¿‡") || true

RUN echo "âœ… æœ€ç»ˆéªŒè¯..." && \
    python -c "import fastapi; import uvicorn; print('âœ… FastAPI å’Œ uvicorn å¯ç”¨')" && \
    python -m uvicorn --version

# æ³¨æ„ï¼šä»£ç é€šè¿‡ volume æŒ‚è½½ï¼Œä¸éœ€è¦ COPY
# è¿™æ ·å¯ä»¥å®ç°å¼€å‘æ¨¡å¼ä¸‹çš„çƒ­é‡è½½

# æš´éœ² FastAPI ç«¯å£
EXPOSE 8000

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8000/health || exit 1

# é»˜è®¤å‘½ä»¤ï¼ˆä¼šè¢« docker-compose è¦†ç›–ï¼‰
CMD ["python", "-m", "uvicorn", "api.main:app", "--host", "0.0.0.0", "--port", "8000"]

